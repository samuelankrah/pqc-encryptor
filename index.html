<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ENTAQ | Post-Quantum Encryption Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ─── Base & Layout ─────────────────────────────────── */
    body {
      background: #fff;
      color: #222;
      font-family: 'Segoe UI', sans-serif;
      max-width: 800px;
      margin: auto;
      padding: 2rem;
      line-height: 1.5;
    }
    header, main { display: block; }
    img.logo { display: block; margin: 0 auto; width: 140px; }
    h1 { text-align: center; color: #0066cc; margin: .5rem 0; }
    .tagline { text-align: center; color: #555; margin-bottom: 2rem; }

    /* ─── Banner ─────────────────────────────────────────── */
    .banner {
      background: #f9f9f9;
      border-left: 5px solid #0066cc;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }

    /* ─── Toggle Info ────────────────────────────────────── */
    .toggle {
      color: #0066cc;
      cursor: pointer;
      text-align: center;
      margin: 1rem 0;
    }
    .info {
      display: none;
      background: #fdfdfd;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 1rem;
    }

    /* ─── Form Controls ──────────────────────────────────── */
    label { display: block; margin-top: 1rem; font-weight: bold; }
    textarea, button {
      width: 100%;
      padding: 1rem;
      margin-top: .5rem;
      border-radius: 8px;
      font-size: 1rem;
      border: 1px solid #ccc;
    }
    textarea { resize: vertical; min-height: 120px; }
    button {
      cursor: pointer;
      font-weight: bold;
      border: none;
    }
    .encrypt-btn { background: #0066cc; color: #fff; }
    .decrypt-btn { background: #ff6600; color: #fff; margin-top: .5rem; }

    /* ─── Results ────────────────────────────────────────── */
    .output {
      display: none;
      background: #fbfbfb;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1.5rem;
      word-break: break-word;
    }
    .output h2 { margin-top: 0; color: #0066cc; }
    .label { font-weight: bold; margin-top: 1rem; }

    /* ─── Responsive ─────────────────────────────────────── */
    @media (max-width: 600px) {
      body { padding: 1rem; }
      textarea, button { font-size: .9rem; }
    }
  </style>
</head>
<body>

  <header>
    <img src="ENTAQ Logo!.png" alt="ENTAQ Logo" class="logo" />
    <h1>ENTAQ</h1>
    <p class="tagline">Encrypted. Entangled. Empowered.</p>
  </header>

  <main>
    <div class="banner">
      🔐 <strong>Post-Quantum Encryption Demo</strong><br>
      Kyber768 (quantum-safe) + AES-GCM (industry-standard) all in your browser.
    </div>

    <div class="toggle" onclick="toggleInfo()" role="button" tabindex="0">
      🔎 Show “What This Means”
    </div>
    <div class="info" id="explain-box" aria-live="polite">
      <p><strong>Why Post-Quantum?</strong> Quantum computers will break RSA/ECC. Kyber768 is NIST-approved to resist future quantum attacks.</p>
      <p><strong>How It Works (Hybrid Encryption):</strong><br>
        1. Kyber768 generates a shared secret (key exchange).<br>
        2. AES-GCM encrypts your actual message with that secret.<br>
        3. You can decrypt it to prove round-trip integrity.
      </p>
      <p><strong>Compliance Ready:</strong><br>
        • PCI DSS 4.0 (Sections 3.4, 3.6)<br>
        • NIST SP 800-57 & SP 800-208 guidelines<br>
        Demonstrates forward-thinking data protection.
      </p>
      <p style="font-size:.85rem; color:#666;">
        Runs entirely in your browser. No data ever leaves your machine.
      </p>
    </div>

    <section>
      <label for="plaintext">Enter Message</label>
      <textarea id="plaintext" aria-label="Plaintext input" placeholder="Type your confidential message…"></textarea>
      <button type="button" class="encrypt-btn" id="encryptBtn">Encrypt</button>
      <button type="button" class="decrypt-btn" id="decryptBtn" disabled>Decrypt</button>
    </section>

    <section class="output" id="results" aria-live="polite">
      <h2>🔐 Results</h2>
      <div class="label">Ciphertext (Base64):</div>
      <div id="ciphertext"></div>
      <div class="label">Shared Secret (Base64):</div>
      <div id="shared"></div>
      <div class="label">Decrypted Message:</div>
      <div id="decrypted"></div>
    </section>
  </main>

  <script type="module">
    // Use the OpenPGP.js fork of crystals-kyber-js via unpkg
    import { MlKem768 } from 'https://unpkg.com/@openpgp/crystals-kyber-js@1.1.1/esm/mod.js';

    // State
    let secretKey, ciphertextBytes, sharedSecret, iv, encryptedPayload;

    // Elements
    const encBtn      = document.getElementById('encryptBtn');
    const decBtn      = document.getElementById('decryptBtn');
    const results     = document.getElementById('results');
    const cipherEl    = document.getElementById('ciphertext');
    const sharedEl    = document.getElementById('shared');
    const decryptedEl = document.getElementById('decrypted');
    const explainBox  = document.getElementById('explain-box');

    const encoder = new TextEncoder();
    const decoder = new TextDecoder();

    // Toggle non-tech info
    function toggleInfo() {
      explainBox.style.display = explainBox.style.display === 'block' ? 'none' : 'block';
    }

    // ENCRYPT
    encBtn.addEventListener('click', async () => {
      const msg = document.getElementById('plaintext').value.trim();
      if (!msg) return alert('Please enter a message.');

      // UI feedback
      encBtn.disabled = true;
      encBtn.textContent = 'Encrypting…';
      decBtn.disabled = true;
      results.style.display = 'none';

      // 1) Generate keypair
      const kem = new MlKem768();
      const [publicKey, sk] = await kem.generateKeyPair();
      secretKey = sk;

      // 2) Encapsulate
      const [ct, ss] = await kem.encap(publicKey);
      ciphertextBytes = ct;
      sharedSecret    = ss;

      // 3) AES-GCM encrypt
      iv = crypto.getRandomValues(new Uint8Array(12));
      const aesKey = await crypto.subtle.importKey('raw', sharedSecret, { name:'AES-GCM' }, false, ['encrypt']);
      const ctBuf  = await crypto.subtle.encrypt({ name:'AES-GCM', iv }, aesKey, encoder.encode(msg));
      encryptedPayload = new Uint8Array(iv.length + ctBuf.byteLength);
      encryptedPayload.set(iv, 0);
      encryptedPayload.set(new Uint8Array(ctBuf), iv.length);

      // Display results
      cipherEl.textContent    = btoa(String.fromCharCode(...encryptedPayload));
      sharedEl.textContent    = btoa(String.fromCharCode(...sharedSecret));
      decryptedEl.textContent = '(Click Decrypt to verify)';
      results.style.display   = 'block';

      // Restore buttons
      encBtn.disabled = false;
      encBtn.textContent = 'Encrypt';
      decBtn.disabled = false;
    });

    // DECRYPT
    decBtn.addEventListener('click', async () => {
      decBtn.disabled = true;
      decBtn.textContent = 'Decrypting…';

      try {
        const kem = new MlKem768();
        const derived = await kem.decap(ciphertextBytes, secretKey);
        const aesKey = await crypto.subtle.importKey('raw', derived, { name:'AES-GCM' }, false, ['decrypt']);
        const ptBuf  = await crypto.subtle.decrypt({ name:'AES-GCM', iv }, aesKey, encryptedPayload.slice(iv.length));
        decryptedEl.textContent = decoder.decode(ptBuf);
      } catch {
        decryptedEl.textContent = '⚠️ Decryption failed';
      }

      decBtn.disabled = false;
      decBtn.textContent = 'Decrypt';
    });
  </script>

</body>
</html>
