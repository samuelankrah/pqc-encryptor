<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>ENTAQ | PQC Demo (Real Kyber)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body { background: #fff; color: #222; font-family: 'Segoe UI', sans-serif; max-width: 800px; margin: auto; padding: 2rem; line-height: 1.5; }
    header { text-align: center; margin-bottom: 2rem; }
    img.logo { width: 140px; display: block; margin: auto; }
    h1 { color: #0066cc; margin: .5rem 0; }
    .tagline { color: #555; margin-bottom: 1.5rem; }
    .banner { background: #f9f9f9; border-left: 5px solid #0066cc; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; }
    .toggle { color: #0066cc; cursor: pointer; text-align: center; margin: 1rem 0; }
    .info { display: none; background: #fdfdfd; border: 1px solid #ccc; border-radius: 8px; padding: 1rem; }
    label { display: block; margin-top: 1rem; font-weight: bold; }
    textarea, button { width: 100%; padding: 1rem; margin-top: .5rem; border-radius: 8px; font-size: 1rem; border: 1px solid #ccc; }
    textarea { resize: vertical; min-height: 120px; }
    button { font-weight: bold; border: none; cursor: pointer; }
    .encrypt-btn { background: #0066cc; color: #fff; }
    .decrypt-btn { background: #ff6600; color: #fff; margin-top: .5rem; }
    .output { display: none; background: #fbfbfb; border: 1px solid #ddd; border-radius: 8px; padding: 1rem; margin-top: 1.5rem; word-break: break-word; }
    .output.visible { display: block; }
    .label { font-weight: bold; margin-top: 1rem; }
    @media (max-width:600px) { body { padding:1rem; } textarea,button { font-size:.9rem; } }
  </style>
</head>
<body>

  <header>
    <img src="ENTAQ Logo!.png" alt="ENTAQ Logo" class="logo"/>
    <h1>ENTAQ</h1>
    <p class="tagline">Encrypted. Entangled. Empowered.</p>
  </header>

  <div class="banner">
    üîê <strong>Post-Quantum Encryption Demo</strong><br>
    Kyber768 (quantum-safe) + AES-GCM all in your browser.
  </div>

  <div id="toggleBtn" class="toggle">üîé Show ‚ÄúWhat This Means‚Äù</div>
  <div id="infoBox" class="info" aria-live="polite">
    <p><strong>Why Post-Quantum?</strong> RSA/ECC fall to quantum; Kyber768 resists it.</p>
    <p><strong>How It Works:</strong>
      <ol>
        <li>Generate a Kyber768 keypair.</li>
        <li>Encapsulate with the <code>publicKey</code> ‚Üí derive a shared secret.</li>
        <li>Encrypt your message with AES-GCM using that secret.</li>
        <li>Decapsulate + decrypt to prove round-trip.</li>
      </ol>
    </p>
    <p style="font-size:.85rem;color:#666;">
      Aligns with PCI DSS 4.0 & NIST SP 800-57/208. Runs entirely in your browser‚Äîno server, no data leaves your machine.
    </p>
  </div>

  <label for="plaintext">Enter Message</label>
  <textarea id="plaintext" placeholder="Type your confidential message‚Ä¶"></textarea>
  <button id="encryptBtn" class="encrypt-btn" disabled>Loading PQC Engine‚Ä¶</button>
  <button id="decryptBtn" class="decrypt-btn" disabled>Decrypt</button>

  <div id="results" class="output" aria-live="polite">
    <h2>üîê Results</h2>
    <div class="label">Ciphertext (Base64):</div><div id="ciphertext"></div>
    <div class="label">Shared Secret:</div><div id="shared"></div>
    <div class="label">Decrypted Message:</div><div id="decrypted"></div>
  </div>

  <script type="module">
    console.log("üöÄ Loading Kyber768 module‚Ä¶");
    import { MlKem768 } from "https://esm.sh/mlkem@2.3.1";
    console.log("‚úÖ Kyber ready:", MlKem768);

    // Elements
    const toggleBtn = document.getElementById("toggleBtn");
    const infoBox   = document.getElementById("infoBox");
    const encBtn    = document.getElementById("encryptBtn");
    const decBtn    = document.getElementById("decryptBtn");
    const results   = document.getElementById("results");
    const ctEl      = document.getElementById("ciphertext");
    const ssEl      = document.getElementById("shared");
    const decEl     = document.getElementById("decrypted");
    const ptEl      = document.getElementById("plaintext");

    let sk, ciphertextBytes, sharedSecret, iv, payload;

    // Toggle explanation
    toggleBtn.onclick = () => {
      const on = infoBox.style.display === "block";
      infoBox.style.display = on ? "none" : "block";
      toggleBtn.textContent = on ? "üîé Show ‚ÄúWhat This Means‚Äù" : "üîé Hide ‚ÄúWhat This Means‚Äù";
    };

    // Enable Encrypt once module loads
    encBtn.disabled = false;
    encBtn.textContent = "Encrypt";

    // Encrypt flow
    encBtn.onclick = async () => {
      const msg = ptEl.value.trim();
      if (!msg) return alert("Please type a message to encrypt.");

      encBtn.disabled = true; encBtn.textContent = "Encrypting‚Ä¶";
      decBtn.disabled = true;
      results.classList.remove("visible");

      // 1) Keypair
      const kem = new MlKem768();
      const [pk, skLocal] = await kem.generateKeyPair();
      sk = skLocal;

      // 2) Encapsulate using the captured public key
      [ciphertextBytes, sharedSecret] = await kem.encap(pk);

      // 3) AES-GCM encrypt
      iv = crypto.getRandomValues(new Uint8Array(12));
      const aesKey = await crypto.subtle.importKey("raw", sharedSecret, "AES-GCM", false, ["encrypt"]);
      const ctBuf  = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, aesKey, new TextEncoder().encode(msg));
      payload     = new Uint8Array(iv.length + ctBuf.byteLength);
      payload.set(iv, 0);
      payload.set(new Uint8Array(ctBuf), iv.length);

      // Display
      ctEl.textContent = btoa(String.fromCharCode(...payload));
      ssEl.textContent = btoa(String.fromCharCode(...sharedSecret));
      decEl.textContent= "(Click Decrypt to verify)";
      results.classList.add("visible");

      encBtn.disabled = false; encBtn.textContent = "Encrypt";
      decBtn.disabled = false;
    };

    // Decrypt flow
    decBtn.onclick = async () => {
      decBtn.disabled = true; decBtn.textContent = "Decrypting‚Ä¶";
      try {
        const kem = new MlKem768();
        const ss2 = await kem.decap(ciphertextBytes, sk);
        const aesKey = await crypto.subtle.importKey("raw", ss2, "AES-GCM", false, ["decrypt"]);
        const ptBuf  = await crypto.subtle.decrypt({ name: "AES-GCM", iv }, aesKey, payload.slice(iv.length));
        decEl.textContent = new TextDecoder().decode(ptBuf);
      } catch {
        decEl.textContent = "‚ö†Ô∏è Decryption failed";
      }
      decBtn.disabled = false; decBtn.textContent = "Decrypt";
    };
  </script>
</body>
</html>
