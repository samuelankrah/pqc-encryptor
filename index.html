<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>ENTAQ | Post-Quantum Encryption Demo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    /* Base & layout */
    body {
      background: #fff;
      color: #222;
      font-family: 'Segoe UI', sans-serif;
      max-width: 800px;
      margin: auto;
      padding: 2rem;
      line-height: 1.5;
    }
    header { text-align: center; margin-bottom: 2rem; }
    img.logo { width: 140px; }
    h1 { color: #0066cc; margin: 0.5rem 0; }
    .tagline { color: #555; margin-bottom: 1.5rem; }

    /* Banner */
    .banner {
      background: #f9f9f9;
      border-left: 5px solid #0066cc;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }

    /* Toggle info */
    .toggle {
      color: #0066cc;
      cursor: pointer;
      text-align: center;
      margin: 1rem 0;
    }
    .info {
      background: #fdfdfd;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 1rem;
      display: none;
    }
    .info.visible { display: block; }

    /* Form */
    label { display: block; margin-top: 1rem; font-weight: bold; }
    textarea, button {
      width: 100%;
      padding: 1rem;
      margin-top: .5rem;
      border-radius: 8px;
      font-size: 1rem;
      border: 1px solid #ccc;
    }
    textarea { resize: vertical; min-height: 120px; }
    button {
      font-weight: bold;
      border: none;
      cursor: pointer;
    }
    .encrypt-btn { background: #0066cc; color: #fff; }
    .decrypt-btn { background: #ff6600; color: #fff; margin-top: .5rem; }

    /* Results */
    .output {
      display: none;
      background: #fbfbfb;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1.5rem;
      word-break: break-word;
    }
    .output.visible { display: block; }
    .output h2 { margin-top: 0; color: #0066cc; }
    .label { font-weight: bold; margin-top: 1rem; }

    /* Responsive */
    @media (max-width:600px) {
      body { padding: 1rem; }
      textarea, button { font-size: .9rem; }
    }
  </style>
</head>
<body>

  <header>
    <img src="ENTAQ Logo!.png" alt="ENTAQ Logo" class="logo"/>
    <h1>ENTAQ</h1>
    <p class="tagline">Encrypted. Entangled. Empowered.</p>
  </header>

  <main>
    <div class="banner">
      üîê <strong>Post-Quantum Encryption Demo</strong><br>
      Kyber-1024 (quantum-safe) + AES-GCM (industry-standard) ‚Äî all in your browser.
    </div>

    <div id="toggleBtn" class="toggle">üîé Show ‚ÄúWhat This Means‚Äù</div>
    <section id="explain-box" class="info" aria-live="polite">
      <p><strong>Why Post-Quantum?</strong> Quantum computers can break RSA/ECC; Kyber is NIST-approved to resist these attacks.</p>
      <p><strong>How It Works</strong> (Hybrid Encryption):
        <ol>
          <li>Generate a PQC keypair (Kyber-1024).</li>
          <li>Encapsulate to derive a shared secret.</li>
          <li>Encrypt your message with AES-GCM using that secret.</li>
        </ol>
      </p>
      <p><strong>Compliance Ready</strong>:
        <ul>
          <li>PCI DSS 4.0 (Sections 3.4, 3.6)</li>
          <li>NIST SP 800-57 & SP 800-208</li>
        </ul>
      </p>
      <p style="font-size:.85rem;color:#666;">Runs 100% in your browser; no server, no data leaves your machine.</p>
    </section>

    <section>
      <label for="plaintext">Enter Message</label>
      <textarea id="plaintext" placeholder="Type your confidential message‚Ä¶"></textarea>
      <button id="encryptBtn" class="encrypt-btn">Encrypt</button>
      <button id="decryptBtn" class="decrypt-btn" disabled>Decrypt</button>
    </section>

    <section id="results" class="output" aria-live="polite">
      <h2>üîê Results</h2>
      <div class="label">Ciphertext (Base64):</div>
      <div id="ciphertext"></div>
      <div class="label">Shared Secret (Base64):</div>
      <div id="shared"></div>
      <div class="label">Decrypted Message:</div>
      <div id="decrypted"></div>
    </section>
  </main>

  <script type="module">
    import { ml_kem1024 } from 'https://cdn.jsdelivr.net/npm/kyber-crystals@1.0.7/esm/index.js';

    // State
    let secretKey, ciphertextBytes, sharedSecret, iv, encryptedPayload;

    // Elements
    const toggleBtn = document.getElementById('toggleBtn');
    const explainBox = document.getElementById('explain-box');
    const encBtn     = document.getElementById('encryptBtn');
    const decBtn     = document.getElementById('decryptBtn');
    const results    = document.getElementById('results');
    const cipherEl   = document.getElementById('ciphertext');
    const sharedEl   = document.getElementById('shared');
    const decryptedEl= document.getElementById('decrypted');

    const encoder = new TextEncoder();
    const decoder = new TextDecoder();

    // Toggle non-tech info
    toggleBtn.addEventListener('click', () => {
      explainBox.classList.toggle('visible');
      toggleBtn.textContent = explainBox.classList.contains('visible')
        ? 'üîé Hide ‚ÄúWhat This Means‚Äù'
        : 'üîé Show ‚ÄúWhat This Means‚Äù';
    });

    // Encrypt
    encBtn.addEventListener('click', async () => {
      const msg = document.getElementById('plaintext').value.trim();
      if (!msg) return alert('Please enter a message.');

      encBtn.disabled = true;
      encBtn.textContent = 'Encrypting‚Ä¶';
      decBtn.disabled = true;
      results.classList.remove('visible');

      // 1) Generate Kyber keypair
      const kem = new ml_kem1024();
      const { privateKey, publicKey } = await kem.keyPair();

      secretKey = privateKey;

      // 2) Encapsulate ‚Üí ciphertext + shared secret
      ({ cyphertext: ciphertextBytes, secret: sharedSecret } = await kem.encrypt(publicKey));

      // 3) AES-GCM encrypt
      iv = crypto.getRandomValues(new Uint8Array(12));
      const aesKey = await crypto.subtle.importKey(
        'raw', sharedSecret, { name:'AES-GCM' }, false, ['encrypt']
      );
      const ctBuf = await crypto.subtle.encrypt(
        { name:'AES-GCM', iv }, aesKey, encoder.encode(msg)
      );
      encryptedPayload = new Uint8Array(iv.length + ctBuf.byteLength);
      encryptedPayload.set(iv, 0);
      encryptedPayload.set(new Uint8Array(ctBuf), iv.length);

      // Display
      cipherEl.textContent = btoa(String.fromCharCode(...encryptedPayload));
      sharedEl.textContent = btoa(String.fromCharCode(...sharedSecret));
      decryptedEl.textContent = '(Click Decrypt to verify)';
      results.classList.add('visible');

      encBtn.disabled = false;
      encBtn.textContent = 'Encrypt';
      decBtn.disabled = false;
    });

    // Decrypt
    decBtn.addEventListener('click', async () => {
      decBtn.disabled = true;
      decBtn.textContent = 'Decrypting‚Ä¶';
      try {
        const kem = new ml_kem1024();
        const derived = await kem.decrypt(ciphertextBytes, secretKey);
        const aesKey = await crypto.subtle.importKey(
          'raw', derived, { name:'AES-GCM' }, false, ['decrypt']
        );
        const ptBuf = await crypto.subtle.decrypt(
          { name:'AES-GCM', iv }, aesKey, encryptedPayload.slice(iv.length)
        );
        decryptedEl.textContent = decoder.decode(ptBuf);
      } catch {
        decryptedEl.textContent = '‚ö†Ô∏è Decryption failed';
      }
      decBtn.disabled = false;
      decBtn.textContent = 'Decrypt';
    });
  </script>
</body>
</html>
